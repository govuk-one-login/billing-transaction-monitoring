TransactionDB:
  Type: AWS::Glue::Database
  Properties:
    CatalogId: !Ref AWS::AccountId
    DatabaseInput:
      Name: btm-transactions

TransactionTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Ref AWS::AccountId
    DatabaseName: !Ref TransactionDB
    TableInput:
      Name: btm-transactions
      TableType: EXTERNAL_TABLE
      Parameters:
        has_encrypted_data: "true"
        projection.enabled: "true"
        projection.event_name.type: enum
        projection.event_name.values: "EVENT_1,EVENT_2,EVENT_3,EVENT_4,EVENT_5,EVENT_6,EVENT_7,EVENT_8"
        projection.day.type: integer
        projection.day.range: 1,31
        projection.month.type: integer
        projection.month.range: 1,12
        projection.year.type: integer
        projection.year.range: 1970,2570
        storage.location.template: !Join [ '', [ 's3://', !Ref StorageBucket, '/event_name=${event_name}/year=${year}/month=${month}/day=${day}/' ] ]
      PartitionKeys:
        - Name: event_name
          Type: string
        - Name: year
          Type: int
        - Name: month
          Type: int
        - Name: day
          Type: int
      StorageDescriptor:
        Columns:
          - { Name: "event_id", Type: string }
          - { Name: "client_id", Type: string }
          - { Name: "timestamp", Type: bigint }
          - { Name: "timestamp_formatted", Type: string }
          - { Name: "component_id", Type: string }
          - { Name: "user", Type: string }
          - { Name: "platform", Type: string }
          - { Name: "restricted", Type: string }
          - { Name: "extensions", Type: string }
        Compressed: true
        InputFormat: "org.apache.hadoop.mapred.TextInputFormat"
        Location: !Join [ '', [ 's3://', !Ref StorageBucket, '/' ] ]
        StoredAsSubDirectories: false
        OutputFormat: "org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat"
        SerdeInfo:
          Parameters: { "ignore.malformed.json": true,"serialiazation.format": 1,"field.delim": "" }
          SerializationLibrary: "org.openx.data.jsonserde.JsonSerDe"

AthenaTransactionWorkgroup:
  Type: AWS::Athena::WorkGroup
  Properties:
    Name: BTMAthenaWorkgroup
    WorkGroupConfiguration:
      EnforceWorkGroupConfiguration: true
      PublishCloudWatchMetricsEnabled: false
      ResultConfiguration:
        EncryptionConfiguration:
          EncryptionOption: "SSE_KMS"
          KmsKey: !GetAtt KmsKey.Arn
        OutputLocation: !Join [ '', ['s3://', !Ref AthenaQueryResultsBucket, '/']]

AthenaQueryResultsBucket:
  Type: AWS::S3::Bucket
  Properties:
    VersioningConfiguration:
      Status: "Enabled"
    BucketEncryption:
      ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: aws:kms
            KMSMasterKeyID: !GetAtt KmsKey.Arn
    PublicAccessBlockConfiguration:
      BlockPublicAcls: true
      BlockPublicPolicy: true
      IgnorePublicAcls: true
      RestrictPublicBuckets: true
    LoggingConfiguration:
      DestinationBucketName: !Ref AthenaAccessLogBucket
    LifecycleConfiguration:
      Rules:
        - ExpirationInDays: 7
          Status: Enabled

AthenaAccessLogBucket:
  # checkov:skip=CKV_AWS_18: This is the access log bucket - no need for another
  Type: 'AWS::S3::Bucket'
  Properties:
    VersioningConfiguration:
      Status: Enabled
    AccessControl: LogDeliveryWrite
    PublicAccessBlockConfiguration:
      BlockPublicAcls: true
      BlockPublicPolicy: true
      IgnorePublicAcls: true
      RestrictPublicBuckets: true
    BucketEncryption:
      ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: aws:kms
            KMSMasterKeyID: !GetAtt KmsKey.Arn
